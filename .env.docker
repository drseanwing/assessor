# =============================================================================
# REdI Assessment System - Docker Environment Configuration
# =============================================================================
# QUICK START (Development):
#   1. Copy this file: cp .env.docker .env
#   2. Change DB_PASSWORD and JWT_SECRET (required)
#   3. Run: docker compose up -d
#
# For production deployment, also configure the REdI API integration URLs below.
# =============================================================================

# =============================================================================
# CRITICAL CONFIGURATION WARNINGS
# =============================================================================
#
# IMPORTANT - READ BEFORE FIRST RUN:
#
# 1. JWT_SECRET MUST be at least 32 characters long
#    - PostgREST will REFUSE TO START if JWT_SECRET is too short
#    - Use a strong random string (recommended: 64+ characters)
#
# 2. DB_PASSWORD must be set BEFORE first `docker compose up`
#    - The authenticator role gets this password during initial DB setup
#    - If you change DB_PASSWORD after the first run, you must EITHER:
#      a) Update the authenticator role manually in the database, OR
#      b) Delete the postgres volume and recreate the database
#
# 3. SUPABASE_ANON_KEY must match your JWT_SECRET
#    - If you change JWT_SECRET, you MUST regenerate this token
#    - See instructions below in the JWT section
#
# =============================================================================

# -----------------------------------------------------------------------------
# DATABASE
# -----------------------------------------------------------------------------
# Password for the redi_admin PostgreSQL superuser and the authenticator role.
#
# WARNING: Set this BEFORE your first `docker compose up`!
# The authenticator role password is set during initial database creation.
# If you change this after first run, you must also update the authenticator
# role in the database or delete the volume and start fresh.
#
# CHANGE THIS in production!
DB_PASSWORD=redi_secret_change_me

# -----------------------------------------------------------------------------
# JWT / AUTHENTICATION
# -----------------------------------------------------------------------------
# Shared secret for signing JWTs. PostgREST and the worker both use this.
#
# CRITICAL: Must be at least 32 characters long!
# PostgREST will refuse to start with a shorter secret.
#
# Recommendation: Use 64+ random characters for production.
# Generate with: openssl rand -base64 48
#
# CHANGE THIS in production!
JWT_SECRET=super-secret-jwt-token-for-redi-assessment-minimum-32-chars

# Anon key: a JWT with {"role":"web_anon"} signed by JWT_SECRET above.
# The default below is pre-signed with the default JWT_SECRET.
#
# IMPORTANT: If you change JWT_SECRET, you MUST regenerate this token!
#
# To regenerate SUPABASE_ANON_KEY:
#   1. Replace YOUR_JWT_SECRET_HERE with your actual JWT_SECRET in the command below
#   2. Run the command and paste the output here
#
# Generate with Node.js:
#   node -e "const c=require('crypto'),h=Buffer.from(JSON.stringify({alg:'HS256',typ:'JWT'})).toString('base64url'),p=Buffer.from(JSON.stringify({role:'web_anon',iss:'redi-assessment',iat:1700000000,exp:2000000000})).toString('base64url'),s=c.createHmac('sha256','YOUR_JWT_SECRET_HERE').update(h+'.'+p).digest('base64url');console.log(h+'.'+p+'.'+s)"
#
# Or use an online JWT generator like https://jwt.io with:
#   Algorithm: HS256
#   Payload: {"role":"web_anon","iss":"redi-assessment","iat":1700000000,"exp":2000000000}
#   Secret: YOUR_JWT_SECRET
#
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoid2ViX2Fub24iLCJpc3MiOiJyZWRpLWFzc2Vzc21lbnQiLCJpYXQiOjE3MDAwMDAwMDAsImV4cCI6MjAwMDAwMDAwMH0.0kvCzSN2-C1ixi73OJsue5ktCYCKNbt7P0G7mLtk__g

# -----------------------------------------------------------------------------
# REdI API INTEGRATION (Azure Logic Apps)
# -----------------------------------------------------------------------------
# OPTIONAL: Required only for REdI system integration (participant sync, email, calendar).
#
# For local development and standalone assessment workflows, you can leave these
# URLs empty. The system will function normally for local assessments, but
# sync/email/calendar features will be disabled.
#
# For production deployment with full REdI integration, configure all URLs below.
#
# Base URL for the REdI Power Automate / Logic Apps endpoints.
REDI_API_BASE_URL=https://prod-xx.australiaeast.logic.azure.com

# Individual endpoint URLs (each is a full Logic App HTTP trigger URL with SAS token).
# These are used by the worker to sync data with the REdI system.
#
# Leave empty for development without REdI integration.
REDI_PARTICIPANT_LOOKUP_URL=
REDI_EVENT_AVAILABILITY_URL=
REDI_FACULTY_AVAILABILITY_URL=
REDI_PARTICIPANT_UPSERT_URL=
REDI_EVENT_UPSERT_URL=
REDI_SEND_EMAIL_URL=
REDI_CALENDAR_EVENT_URL=
REDI_EMAIL_CERTIFICATE_URL=

# -----------------------------------------------------------------------------
# REPORTING
# -----------------------------------------------------------------------------
# Email address to send generated reports to.
# Only used when email integration is configured above.
REPORT_EMAIL_TO=redi@health.qld.gov.au

# =============================================================================
# TROUBLESHOOTING
# =============================================================================
#
# Problem: PostgREST container exits immediately
# Solution: Check that JWT_SECRET is at least 32 characters long
#
# Problem: Database authentication fails after changing DB_PASSWORD
# Solution: Either recreate the database volume, or manually update the
#           authenticator role password in PostgreSQL:
#           ALTER ROLE authenticator WITH PASSWORD 'your-new-password';
#
# Problem: Frontend shows "Invalid JWT" errors
# Solution: Ensure SUPABASE_ANON_KEY was regenerated with the current JWT_SECRET
#
# Problem: REdI sync features not working
# Solution: Check that all REDI_*_URL variables are set correctly with valid
#           SAS tokens. For development without REdI, this is expected behavior.
#
# Problem: Worker container keeps restarting
# Solution: Check worker logs with: docker compose logs worker
#           Verify REDI_API_BASE_URL is accessible if integration is enabled
#
# For more help, see README.md or the documentation in the docs/ directory.
# =============================================================================
