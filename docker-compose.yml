# REdI Assessment System - Docker Compose
# Self-contained deployment: PostgreSQL + PostgREST + Worker + Frontend
#
# Usage:
#   cp .env.docker.example .env # Configure environment
#   docker compose up -d       # Start all services
#   docker compose logs -f     # View logs
#
# Services:
#   db       - PostgreSQL 16 (port 5432)
#   rest     - PostgREST API (port 3000, proxied via nginx)
#   worker   - Node.js backend for REdI sync/reports/email (port 5000, proxied via nginx)
#   frontend - nginx serving React SPA + reverse proxy (port 8080)

name: redi-assessment

services:
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    # Port 5432 is only reachable within the Docker network.
    # For admin access, use: docker compose exec db psql -U redi_admin -d redi_assessment
    environment:
      POSTGRES_DB: redi_assessment
      POSTGRES_USER: redi_admin
      POSTGRES_PASSWORD: ${DB_PASSWORD:?Set DB_PASSWORD in .env before starting}
      DB_AUTHENTICATOR_PASSWORD: ${DB_AUTHENTICATOR_PASSWORD:-}
      DB_WORKER_PASSWORD: ${DB_WORKER_PASSWORD:-}
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U redi_admin -d redi_assessment"]
      interval: 10s
      timeout: 5s
      retries: 5
    command:
      - "postgres"
      - "-c"
      - "wal_level=logical"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'

  rest:
    build: ./docker/postgrest
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      PGRST_DB_URI: postgres://authenticator:${DB_AUTHENTICATOR_PASSWORD:-${DB_PASSWORD:?Set DB_PASSWORD in .env}}@db:5432/redi_assessment
      PGRST_DB_SCHEMAS: public
      PGRST_DB_ANON_ROLE: web_anon
      PGRST_JWT_SECRET: ${JWT_SECRET:?Set JWT_SECRET in .env (min 32 chars)}
      PGRST_DB_EXTRA_SEARCH_PATH: public
      PGRST_DB_POOL: 10
      PGRST_DB_POOL_TIMEOUT: 10
    # PostgREST is only reachable within Docker network (proxied via nginx at /rest/v1/)
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:3000/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'

  worker:
    build: ./worker
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      rest:
        condition: service_healthy
    environment:
      DATABASE_URL: postgres://redi_worker:${DB_WORKER_PASSWORD:-${DB_PASSWORD:?Set DB_PASSWORD in .env}}@db:5432/redi_assessment
      REDI_API_BASE_URL: ${REDI_API_BASE_URL:-https://prod-xx.australiaeast.logic.azure.com}
      REDI_PARTICIPANT_LOOKUP_URL: ${REDI_PARTICIPANT_LOOKUP_URL:-}
      REDI_EVENT_AVAILABILITY_URL: ${REDI_EVENT_AVAILABILITY_URL:-}
      REDI_FACULTY_AVAILABILITY_URL: ${REDI_FACULTY_AVAILABILITY_URL:-}
      REDI_PARTICIPANT_UPSERT_URL: ${REDI_PARTICIPANT_UPSERT_URL:-}
      REDI_EVENT_UPSERT_URL: ${REDI_EVENT_UPSERT_URL:-}
      REDI_SEND_EMAIL_URL: ${REDI_SEND_EMAIL_URL:-}
      REDI_CALENDAR_EVENT_URL: ${REDI_CALENDAR_EVENT_URL:-}
      REDI_EMAIL_CERTIFICATE_URL: ${REDI_EMAIL_CERTIFICATE_URL:-}
      REPORT_EMAIL_TO: ${REPORT_EMAIL_TO:-redi@health.qld.gov.au}
      JWT_SECRET: ${JWT_SECRET:?Set JWT_SECRET in .env (min 32 chars)}
      PORT: 5000
      NODE_ENV: production
    # Worker is only reachable within Docker network (proxied via nginx at /worker/)
    volumes:
      - reports:/app/data/reports
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:5000/api/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'

  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VITE_SUPABASE_URL: ""
        VITE_SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:?Set SUPABASE_ANON_KEY in .env (must match JWT_SECRET)}
    restart: unless-stopped
    depends_on:
      rest:
        condition: service_healthy
      worker:
        condition: service_healthy
    ports:
      - "8080:80"
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:80/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.5'

volumes:
  pgdata:
    driver: local
  reports:
    driver: local

# Database Backup Strategy:
# Run periodic pg_dump via cron on the host machine:
#   0 2 * * * docker compose exec -T db pg_dump -U redi_admin redi_assessment | gzip > /backups/redi_$(date +\%Y\%m\%d).sql.gz
# Or add a backup service to this compose file.
