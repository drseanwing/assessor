# REdI Assessment System - Docker Compose
# Self-contained deployment: PostgreSQL + PostgREST + Worker + Frontend
#
# Usage:
#   cp .env.docker .env        # Configure environment
#   docker compose up -d       # Start all services
#   docker compose logs -f     # View logs
#
# Services:
#   db       - PostgreSQL 16 (port 5432)
#   rest     - PostgREST API (port 3000, proxied via nginx)
#   worker   - Node.js backend for REdI sync/reports/email (port 5000, proxied via nginx)
#   frontend - nginx serving React SPA + reverse proxy (port 80)

services:
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    # Port 5432 is only reachable within the Docker network.
    # For admin access, use: docker compose exec db psql -U redi_admin -d redi_assessment
    environment:
      POSTGRES_DB: redi_assessment
      POSTGRES_USER: redi_admin
      POSTGRES_PASSWORD: ${DB_PASSWORD:-redi_secret_change_me}
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U redi_admin -d redi_assessment"]
      interval: 10s
      timeout: 5s
      retries: 5
    command:
      - "postgres"
      - "-c"
      - "wal_level=logical"

  rest:
    image: postgrest/postgrest:v12.2.3
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      PGRST_DB_URI: postgres://authenticator:${DB_PASSWORD:-redi_secret_change_me}@db:5432/redi_assessment
      PGRST_DB_SCHEMAS: public
      PGRST_DB_ANON_ROLE: web_anon
      PGRST_JWT_SECRET: ${JWT_SECRET:-super-secret-jwt-token-for-redi-assessment-minimum-32-chars}
      PGRST_DB_EXTRA_SEARCH_PATH: public
      PGRST_DB_POOL: 10
      PGRST_DB_POOL_TIMEOUT: 10
    # PostgREST is only reachable within Docker network (proxied via nginx at /rest/v1/)
    # Note: No healthcheck - PostgREST static binary has no shell/wget

  worker:
    build: ./worker
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      rest:
        condition: service_started
    environment:
      DATABASE_URL: postgres://redi_admin:${DB_PASSWORD:-redi_secret_change_me}@db:5432/redi_assessment
      REDI_API_BASE_URL: ${REDI_API_BASE_URL:-https://prod-xx.australiaeast.logic.azure.com}
      REDI_PARTICIPANT_LOOKUP_URL: ${REDI_PARTICIPANT_LOOKUP_URL:-}
      REDI_EVENT_AVAILABILITY_URL: ${REDI_EVENT_AVAILABILITY_URL:-}
      REDI_FACULTY_AVAILABILITY_URL: ${REDI_FACULTY_AVAILABILITY_URL:-}
      REDI_PARTICIPANT_UPSERT_URL: ${REDI_PARTICIPANT_UPSERT_URL:-}
      REDI_EVENT_UPSERT_URL: ${REDI_EVENT_UPSERT_URL:-}
      REDI_SEND_EMAIL_URL: ${REDI_SEND_EMAIL_URL:-}
      REDI_CALENDAR_EVENT_URL: ${REDI_CALENDAR_EVENT_URL:-}
      REDI_EMAIL_CERTIFICATE_URL: ${REDI_EMAIL_CERTIFICATE_URL:-}
      REPORT_EMAIL_TO: ${REPORT_EMAIL_TO:-redi@health.qld.gov.au}
      JWT_SECRET: ${JWT_SECRET:-super-secret-jwt-token-for-redi-assessment-minimum-32-chars}
      PORT: 5000
      NODE_ENV: production
    # Worker is only reachable within Docker network (proxied via nginx at /worker/)
    volumes:
      - reports:/app/data/reports
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:5000/api/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VITE_SUPABASE_URL: ""
        VITE_SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoid2ViX2Fub24iLCJpc3MiOiJyZWRpLWFzc2Vzc21lbnQiLCJpYXQiOjE3MDAwMDAwMDAsImV4cCI6MjAwMDAwMDAwMH0.0kvCzSN2-C1ixi73OJsue5ktCYCKNbt7P0G7mLtk__g}
    restart: unless-stopped
    depends_on:
      rest:
        condition: service_started
      worker:
        condition: service_healthy
    ports:
      - "${FRONTEND_PORT:-7385}:80"
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:80/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  pgdata:
    driver: local
  reports:
    driver: local
