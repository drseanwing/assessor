# =============================================================================
# REdI Assessment System - Portainer Stack
# =============================================================================
# Pre-built images from DockerHub. No local builds required.
#
# Deployment:
#   1. In Portainer, go to Stacks > Add Stack
#   2. Paste this file into the Web Editor (or use Git Repository)
#   3. Under "Environment variables", add the variables from the env template below
#   4. Deploy the stack
#
# IMPORTANT - First-time database setup:
#   The db/init/ scripts must be accessible to the PostgreSQL container.
#   Option A (Git deploy): Place this repo on the host and use the relative path below.
#   Option B (Manual): Copy the db/init/ folder to /opt/redi-assessment/db-init/ on
#                       the Docker host, then uncomment the alternate volume line below.
#
# =============================================================================

services:
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: redi_assessment
      POSTGRES_USER: redi_admin
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
      # Option A: Git/repo deploy (relative path)
      - ./db/init:/docker-entrypoint-initdb.d
      # Option B: Manual deploy (uncomment and adjust path)
      # - /opt/redi-assessment/db-init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U redi_admin -d redi_assessment"]
      interval: 10s
      timeout: 5s
      retries: 5
    command:
      - "postgres"
      - "-c"
      - "wal_level=logical"

  rest:
    image: postgrest/postgrest:v12.2.3
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      PGRST_DB_URI: postgres://authenticator:${DB_PASSWORD}@db:5432/redi_assessment
      PGRST_DB_SCHEMAS: public
      PGRST_DB_ANON_ROLE: web_anon
      PGRST_JWT_SECRET: ${JWT_SECRET}
      PGRST_DB_EXTRA_SEARCH_PATH: public
      PGRST_DB_POOL: 10
      PGRST_DB_POOL_TIMEOUT: 10

  worker:
    image: medicalresponse/assessor-worker:latest
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      rest:
        condition: service_started
    environment:
      DATABASE_URL: postgres://redi_admin:${DB_PASSWORD}@db:5432/redi_assessment
      JWT_SECRET: ${JWT_SECRET}
      PORT: 5000
      NODE_ENV: production
      REDI_API_BASE_URL: ${REDI_API_BASE_URL}
      REDI_PARTICIPANT_LOOKUP_URL: ${REDI_PARTICIPANT_LOOKUP_URL}
      REDI_EVENT_AVAILABILITY_URL: ${REDI_EVENT_AVAILABILITY_URL}
      REDI_FACULTY_AVAILABILITY_URL: ${REDI_FACULTY_AVAILABILITY_URL}
      REDI_PARTICIPANT_UPSERT_URL: ${REDI_PARTICIPANT_UPSERT_URL}
      REDI_EVENT_UPSERT_URL: ${REDI_EVENT_UPSERT_URL}
      REDI_SEND_EMAIL_URL: ${REDI_SEND_EMAIL_URL}
      REDI_CALENDAR_EVENT_URL: ${REDI_CALENDAR_EVENT_URL}
      REDI_EMAIL_CERTIFICATE_URL: ${REDI_EMAIL_CERTIFICATE_URL}
      REPORT_EMAIL_TO: ${REPORT_EMAIL_TO}
    volumes:
      - reports:/app/data/reports
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://localhost:5000/api/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

  frontend:
    image: medicalresponse/assessor-frontend:latest
    restart: unless-stopped
    depends_on:
      rest:
        condition: service_started
      worker:
        condition: service_healthy
    ports:
      - "${FRONTEND_PORT}:80"
    healthcheck:
      test: ["CMD-SHELL", "wget --spider --quiet http://127.0.0.1:80/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  pgdata:
    driver: local
  reports:
    driver: local
